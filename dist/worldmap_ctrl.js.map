{"version":3,"sources":["../src/worldmap_ctrl.js"],"names":["MetricsPanelCtrl","TimeSeries","kbn","_","mapRenderer","DataFormatter","MP","panelDefaults","ak","maxDataPoints","theme","mapCenterLatitude","mapCenterLongitude","initialZoom","valueName","locationData","esMetric","decimals","navigation","scale","overviewMap","mapType","WorldmapCtrl","$scope","$injector","contextSrv","setMapProvider","defaults","panel","dataFormatter","events","on","onInitEditMode","bind","onDataReceived","onPanelTeardown","onDataSnapshotLoad","loadLocationDataFromFile","tileServer","setMapSaturationClass","saturationClass","reload","map","snapshotLocationData","locations","jsonpUrl","jsonpCallback","window","$","ajax","type","url","contentType","dataType","success","res","render","jsonUrl","getJSON","then","reloadLocations","refresh","remove","addEditorTab","dataList","dashboard","snapshot","data","setGeohashValues","tableData","tableHandler","setTableValues","series","setJsonValues","seriesHandler","setValues","length","mapCenter","centerOnLastGeoHash","mapCenters","last","locationLatitude","locationLongitude","setNewMapCenter","snapshotData","seriesData","datapoints","alias","target","flotpairs","getFlotPairs","nullPointMode","mapCenterMoved","setZoom","parseInt","setMapStyle","style","x","document","body","s","getElementsByTagName","len","removeChild","addControl","navigationSwitch","removeControl","scaleSwitch","overviewMapSwitch","mapTypeSwitch","console","log","stickyLabels","scope","elem","attrs","ctrl","templateUrl"],"mappings":"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","file":"worldmap_ctrl.js","sourcesContent":["/* eslint import/no-extraneous-dependencies: 0 */\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport TimeSeries from 'app/core/time_series2';\nimport kbn from 'app/core/utils/kbn';\n\nimport _ from 'lodash';\nimport mapRenderer from './map_renderer';\nimport DataFormatter from './data_formatter';\nimport './css/worldmap-panel.css!';\nimport { MP } from \"./libs/baidumap.js\";  \n\nconst panelDefaults = {\n  ak: \"4AWvSkHwSEcX8nwS0bZBcFZTDw70NzZZ\",\n  maxDataPoints: 1,\n  theme: \"normal\",\n  mapCenterLatitude: 116.404,\n  mapCenterLongitude: 39.915,\n  initialZoom: 11,\n  valueName: \"total\",\n  locationData: \"countries\",\n  esMetric: \"Count\",\n  decimals: 0,\n  navigation: true,\n  scale: true,\n  overviewMap: false,\n  mapType: true\n};\n\nexport default class WorldmapCtrl extends MetricsPanelCtrl {\n  constructor($scope, $injector, contextSrv) {\n    super($scope, $injector);\n\n    this.setMapProvider(contextSrv);\n    _.defaults(this.panel, panelDefaults);\n    this.dataFormatter = new DataFormatter(this, kbn);\n\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\n    this.events.on('data-snapshot-load', this.onDataSnapshotLoad.bind(this));\n\n    this.loadLocationDataFromFile();\n  }\n\n  setMapProvider(contextSrv) {\n//    this.tileServer = contextSrv.user.lightTheme ? 'CartoDB Positron' : 'CartoDB Dark';\n    this.tileServer = 'CartoDB Positron';\n    this.setMapSaturationClass();\n  }\n\n  setMapSaturationClass() {\n    if (this.tileServer === 'CartoDB Dark') {\n      this.saturationClass = 'map-darken';\n    } else {\n      this.saturationClass = '';\n    }\n  }\n\n  loadLocationDataFromFile(reload) {\n    if (this.map && !reload) return;\n\n    if (this.panel.snapshotLocationData) {\n      this.locations = this.panel.snapshotLocationData;\n      return;\n    }\n\n    if (this.panel.locationData === \"jsonp endpoint\") {\n      if (!this.panel.jsonpUrl || !this.panel.jsonpCallback) return;\n\n      window.$.ajax({\n        type: \"GET\",\n        url: this.panel.jsonpUrl + \"?callback=?\",\n        contentType: \"application/json\",\n        jsonpCallback: this.panel.jsonpCallback,\n        dataType: \"jsonp\",\n        success: res => {\n          this.locations = res;\n          this.render();\n        }\n      });\n    } else if (this.panel.locationData === \"json endpoint\") {\n      if (!this.panel.jsonUrl) return;\n\n      window.$.getJSON(this.panel.jsonUrl).then(res => {\n        this.locations = res;\n        this.render();\n      });\n    } else if (this.panel.locationData === \"table\") {\n      // .. Do nothing\n    } else if (this.panel.locationData !== \"geohash\" && this.panel.locationData !== \"json result\") {\n      window.$.getJSON(\"public/plugins/grafana-worldmap-panel/data/\" + this.panel.locationData + \".json\").then(this.reloadLocations.bind(this));\n    }\n  }\n\n  reloadLocations(res) {\n    this.locations = res;\n    this.refresh();\n  }\n\n  onPanelTeardown() {\n    if (this.map) this.map.remove();\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Baidumap', 'public/plugins/grafana-baidumap-panel/partials/editor.html', 2);\n  }\n\n  onDataReceived(dataList) {\n    if (!dataList) return;\n\n    if (this.dashboard.snapshot && this.locations) {\n      this.panel.snapshotLocationData = this.locations;\n    }\n\n    const data = [];\n\n    if (this.panel.locationData === 'geohash') {\n      this.dataFormatter.setGeohashValues(dataList, data);\n    } else if (this.panel.locationData === 'table') {\n      const tableData = dataList.map(DataFormatter.tableHandler.bind(this));\n      this.dataFormatter.setTableValues(tableData, data);\n    } else if (this.panel.locationData === 'json result') {\n      this.series = dataList;\n      this.dataFormatter.setJsonValues(data);\n    } else {\n      this.series = dataList.map(this.seriesHandler.bind(this));\n      this.dataFormatter.setValues(data);\n    }\n    this.data = data;\n\n    if (this.data.length && this.panel.mapCenter === 'Last GeoHash') {\n      this.centerOnLastGeoHash();\n    } else {\n      this.render();\n    }\n  }\n\n  centerOnLastGeoHash() {\n    mapCenters[this.panel.mapCenter].mapCenterLatitude = _.last(this.data).locationLatitude;\n    mapCenters[this.panel.mapCenter].mapCenterLongitude = _.last(this.data).locationLongitude;\n    this.setNewMapCenter();\n  }\n\n  onDataSnapshotLoad(snapshotData) {\n    this.onDataReceived(snapshotData);\n  }\n\n  seriesHandler(seriesData) {\n    const series = new TimeSeries({\n      datapoints: seriesData.datapoints,\n      alias: seriesData.target,\n    });\n\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    return series;\n  }\n\n  setNewMapCenter() {\n    if (this.panel.mapCenter !== 'custom') {\n      this.panel.mapCenterLatitude = mapCenters[this.panel.mapCenter].mapCenterLatitude;\n      this.panel.mapCenterLongitude = mapCenters[this.panel.mapCenter].mapCenterLongitude;\n    }\n    this.mapCenterMoved = true;\n    this.render();\n  }\n\n  setZoom() {\n    this.map.setZoom(parseInt(this.panel.initialZoom, 10) || 1);\n  }\n\n  setStyle() {\n\t\tthis.map.setMapStyle({ style: this.panel.theme });\n\t}\n\n  setAK() {\n    let x = document.body;\n    let s = document.getElementsByTagName(\"script\");\n    let len = s.length;\n    x.removeChild(s[len - 1]);\n    delete this.map;\n    this.render();\n\t}\n\n  navigationControl() {\n    if (this.panel.navigation == true) {\n      this.map.addControl(this.panel.navigationSwitch);\n    } else {\n      this.map.removeControl(this.panel.navigationSwitch);\n    }\n  }\n\n  scaleControl() {\n    if (this.panel.scale == true) {\n      this.map.addControl(this.panel.scaleSwitch);\n    } else {\n      this.map.removeControl(this.panel.scaleSwitch);\n    }\n  }\n\n  overviewMapControl() {\n    if (this.panel.overviewMap == true) {\n      this.map.addControl(this.panel.overviewMapSwitch);\n    } else {\n      this.map.removeControl(this.panel.overviewMapSwitch);\n    }\n  }\n\n  mapTypeControl() {\n    if (this.panel.mapType == true) {\n      this.map.addControl(this.panel.mapTypeSwitch);\n    } else {\n      this.map.removeControl(this.panel.mapTypeSwitch);\n    }\n  }\n\n  resize() {\n    \n  }\n\n  toggleStickyLabels() {\n    console.log(this.panel.stickyLabels);\n  }\n\n  changeLocationData() {\n    this.loadLocationDataFromFile(true);\n\n    if (this.panel.locationData === 'geohash') {\n      this.render();\n    }\n  }\n\n/* eslint class-methods-use-this: 0 */\n  link(scope, elem, attrs, ctrl) {\n    mapRenderer(scope, elem, attrs, ctrl);\n  }\n}\n\nWorldmapCtrl.templateUrl = 'module.html';\n"]}